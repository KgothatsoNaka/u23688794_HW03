@model u23688794_HW03.Models.ReportModel
@{
    ViewBag.Title = "Sales Report";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<link href="@Url.Content("~/Content/Report.css")" rel="stylesheet" type="text/css"/>

<div class="report-container">
    <h1>Sales Performance Reports</h1>

    
    <div class="date-filter">
        @using (Html.BeginForm("GenerateReport", "Report", FormMethod.Post))
        {
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px;">
                <div class="form-group">
                    <label>Start Date</label>
                    @Html.TextBoxFor(m => m.StartDate, new { @type = "date", @class = "form-control", required = "required" })
                </div>
                <div class="form-group">
                    <label>End Date</label>
                    @Html.TextBoxFor(m => m.EndDate, new { @type = "date", @class = "form-control", required = "required" })
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                    <button type="submit" class="btn btn-primary">Generate Report</button>
                </div>
            </div>
        }
    </div>

    @if (Model.PopularProducts != null && Model.PopularProducts.Any())
    {
        
        <div class="chart-container">
            <div class="chart-box">
                <h3>Top Selling Products</h3>
                <canvas id="productsChart" width="400" height="300"></canvas>
            </div>
            <div class="chart-box">
                <h3>Staff Performance</h3>
                <canvas id="staffChart" width="400" height="300"></canvas>
            </div>
        </div>

        
        <div class="chart-container">
            <div class="chart-box">
                <h3>Popular Products Data</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product Name</th>
                            <th>Brand</th>
                            <th>Category</th>
                            <th>Sales Count</th>
                            <th>Quantity Sold</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var product in Model.PopularProducts)
                        {
                            <tr>
                                <td>@product.product_name</td>
                                <td>@product.brand_name</td>
                                <td>@product.category_name</td>
                                <td>@product.sales_count</td>
                                <td>@product.total_quantity_sold</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="chart-box">
                <h3>Staff Performance Data</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Store Location</th>
                            <th>Total Orders</th>
                            <th>Total Sales</th>
                            <th>Total Revenue</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var staff in Model.StaffPerformances)
                        {
                            <tr>
                                <td>@staff.fullname</td>
                                <td>@staff.store_location</td>
                                <td>@staff.total_orders</td>
                                <td>@staff.total_sales</td>
                                <td>@staff.total_revenue.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        
        <div class="save-section">
            <h3>Save Report</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                <div class="form-group">
                    <label>Filename</label>
                    <input type="text" id="filename" placeholder="Enter filename" class="form-control" required />
                </div>
                <div class="form-group">
                    <label>File Type</label>
                    <select id="filetype" class="form-control">
                        <option value="pdf">PDF</option>
                    </select>
                </div>
                <div class="form-group">
                    <button onclick="saveReport()" class="btn btn-success">Save Report</button>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <h4>Please select a date range.</h4>            
        </div>
    }

    
    <div class="archive-section">
        <h3>Document Archive</h3>
        <button onclick="loadArchive()" class="btn btn-primary">Refresh Archive</button>
        <ul id="fileList" class="file-list"></ul>
    </div>
</div>




@section Scripts {
    <script>
        
        document.addEventListener('DOMContentLoaded', function() {
            @if (Model.PopularProducts != null && Model.PopularProducts.Any())
            {
                <text>
                initializeCharts();
                </text>
            }
            loadArchive();
        });

        function initializeCharts() {
            
            const productsCtx = document.getElementById('productsChart').getContext('2d');
            const productsChart = new Chart(productsCtx, {
                type: 'bar',
                data: {
                    labels: @Html.Raw(Json.Encode(Model.PopularProducts.Select(p => p.product_name))),
                    datasets: [{
                        label: 'Quantity Sold',
                        data: @Html.Raw(Json.Encode(Model.PopularProducts.Select(p => p.total_quantity_sold))),
                        backgroundColor: 'rgba(54, 162, 235, 0.8)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top Selling Products by Quantity'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantity Sold'
                            }
                        }
                    }
                }
            });

            // Staff Performance Chart (Horizontal Bar Chart)
            const staffCtx = document.getElementById('staffChart').getContext('2d');
            const staffChart = new Chart(staffCtx, {
                type: 'bar',
                data: {
                    labels: @Html.Raw(Json.Encode(Model.StaffPerformances.Select(s => s.fullname))),
                    datasets: [{
                        label: 'Revenue Generated',
                        data: @Html.Raw(Json.Encode(Model.StaffPerformances.Select(s => s.total_revenue))),
                        backgroundColor: 'rgba(75, 192, 192, 0.8)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Staff Performance by Revenue'
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (R)'
                            }
                        }
                    }
                }
            });
        }

        async function saveReport() {
            const filename = document.getElementById('filename').value;
            const filetype = document.getElementById('filetype').value;

            if (!filename) {
                alert('Please enter a filename');
                return;
            }

            
                
            await saveAsPDF(filename);
               
          
            loadArchive();
            alert('Report saved successfully!');
         
        }

        async function saveAsPDF(filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            
            doc.setFontSize(20);
            doc.text('Sales Performance Report', 105, 15, { align: 'center' });

            
            doc.setFontSize(12);
            doc.text(`Report Period: ${new Date('@Model.StartDate').toLocaleDateString()} - ${new Date('@Model.EndDate').toLocaleDateString()}`, 105, 25, { align: 'center' });

           
            const productsCanvas = await html2canvas(document.getElementById('productsChart'));
            const staffCanvas = await html2canvas(document.getElementById('staffChart'));

            const productsImg = productsCanvas.toDataURL('image/png');
            const staffImg = staffCanvas.toDataURL('image/png');

            
            doc.addImage(productsImg, 'PNG', 10, 40, 190, 90);

            
            doc.addImage(staffImg, 'PNG', 10, 140, 190, 90);

            
            doc.save(`${filename}.pdf`);

            await uploadToServer(filename + '.pdf', doc.output('blob'));
        }



        async function uploadToServer(filename, blob) {
            const formData = new FormData();
            formData.append('file', blob, filename);

            const response = await fetch('/Report/SaveReport', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('Failed to upload file');
            }
        }

        async function loadArchive() {
            try {
                const response = await fetch('/Report/GetArchivedReports');
                const files = await response.json();

                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';

                files.forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.className = 'file-item';

                    const fileInfo = document.createElement('span');
                    fileInfo.textContent = `${file.FileName} (${formatFileSize(file.FileSize)}) - ${new Date(file.CreatedDate).toLocaleDateString()}`;

                    const actions = document.createElement('div');

                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'Download';
                    downloadBtn.className = 'btn btn-primary';
                    downloadBtn.onclick = () => downloadFile(file.FileName);

                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'btn btn-danger';
                    deleteBtn.onclick = () => deleteFile(file.FileName);

                    actions.appendChild(downloadBtn);
                    actions.appendChild(deleteBtn);

                    listItem.appendChild(fileInfo);
                    listItem.appendChild(actions);
                    fileList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Error loading archive:', error);
            }
        }

        function downloadFile(filename) {
            window.open(`/Reports/${filename}`, '_blank');
        }

        async function deleteFile(filename) {
            if (confirm('Are you sure you want to delete this file?')) {
                try {
                    const response = await fetch('/Report/DeleteReport', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ fileName: filename })
                    });

                    const result = await response.json();

                    if (result.success) {
                        loadArchive();
                    } else {
                        alert('Error deleting file: ' + result.error);
                    }
                } catch (error) {
                    alert('Error deleting file: ' + error.message);
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
}

